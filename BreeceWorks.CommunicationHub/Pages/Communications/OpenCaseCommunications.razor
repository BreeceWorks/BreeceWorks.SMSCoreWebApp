@page "/opencasecommunications"

<h3>Case Communications</h3>
<script type="text/javascript">

    EndOfList = () => {
        var lastChild = document.getElementById("MessageList").lastChild;
        lastChild.parentNode.parentNode.scrollTop = lastChild.offsetTop - lastChild.parentNode.parentNode.offsetTop;
    }
</script>
<div>
    <button @onclick="GoToBottomOfList">Go to bottom of list</button>
</div>
@if (caseTranscript == null)
{
    <p><em>Loading...</em></p>
}
else
{ @if (ErrorMessage != String.Empty)
    {
        <p style="color:red"><em>@ErrorMessage</em></p>
    }
    <table>
        <tr>
            <td>
                @if (caseTranscript.CaseData != null)
                {
                    <h4>Case Data</h4>
                    <p>Case ID: @caseTranscript.CaseData.Id</p>
                    <p>Case ClaimNumber: @caseTranscript.CaseData.ClaimNumber</p>
                    <p>Case DateOfLoss: @caseTranscript.CaseData.DateOfLoss</p>
                    <p>Case PolicyNumber: @caseTranscript.CaseData.PolicyNumber</p>
                    <p>Case Deductible: @caseTranscript.CaseData.Deductible</p>
                    <p>Case Brand:  @caseTranscript.CaseData.Brand</p>
                    <p>Case Archived: @caseTranscript.CaseData.Archived </p>
                    @if (caseTranscript.CaseData.LineOfBusiness != null)
                    {
                        <h5>Line of Business</h5>
                        <p>Type: @caseTranscript.CaseData.LineOfBusiness.Type</p>
                        <p>SubType: @caseTranscript.CaseData.LineOfBusiness.SubType</p>
                    }
                }
        
                <table>
                    <tr>
                        <td><p>Case State: @caseTranscript.State</p></td>
                    </tr>
                </table>
                <p>Case Type: @caseTranscript.CaseType</p>
                <p>Case Business Name: @caseTranscript.BusinessName</p>
                <p>Case Privacy: @caseTranscript.Privacy</p>
                <p>Case Language Preference: @caseTranscript.LanguagePreference</p>
                @if(caseTranscript.Customer != null)
                {
                    <h4>Customer</h4>
                    <p>First Name: @caseTranscript.Customer.First</p>
                    <p>Last Name: @caseTranscript.Customer.Last</p>
                    <p>Email: @caseTranscript.Customer.Email</p>
                    <p>Mobile: @caseTranscript.Customer.Mobile</p>
                    <p>OptStatus: @caseTranscript.Customer.OptStatus</p>
                    <p>OptStatusDetail: @caseTranscript.Customer.OptStatusDetail</p>
                }
                @if (caseTranscript.PrimaryContact != null)
                {
                    <h4>Primary Contact</h4>
                    <p>First Name: @caseTranscript.PrimaryContact.FirstName</p>
                    <p>Last Name: @caseTranscript.PrimaryContact.LastName</p>
                    <p>Email: @caseTranscript.PrimaryContact.Email</p>
                    <p>Mobile: @caseTranscript.PrimaryContact.PhoneNumber</p>
                }
                @if (caseTranscript.CreatedBy != null)
                {
                    <h4>Created By</h4>
                    <p>First Name: @caseTranscript.CreatedBy.FirstName</p>
                    <p>Last Name: @caseTranscript.CreatedBy.LastName</p>
                    <p>Email: @caseTranscript.CreatedBy.Email</p>
                    <p>Mobile: @caseTranscript.CreatedBy.PhoneNumber</p>
                }
                @if(caseTranscript.SecondaryOperators != null)
                {
                    @foreach(BreeceWorks.Shared.CaseObjects.Operator curOperator in caseTranscript.SecondaryOperators)
                    {
                        <h4>Secondary Operator</h4>
                        <p>First Name: @curOperator.FirstName</p>
                        <p>Last Name: @curOperator.LastName</p>
                        <p>Email: @curOperator.Email</p>
                        <p>Mobile: @curOperator.PhoneNumber</p>
                    }
                }

            </td>
            <td style="margin: 0; padding: 0; vertical-align: top">
                <table>
                    <tr>
                        <td>
                            <div style="height: 500px; overflow:auto; margin: 0 ">
                                <ul id="MessageList">
                                    @if (caseTranscript.Messages != null)
                                    {
                                        foreach (BreeceWorks.Shared.CaseObjects.Message message in caseTranscript.Messages)
                                        {
                                            <li>
                                                <table>
                                                    <tr>
                                                        <td>
                                                            <table>
                                                                <tr>
                                                                    <td><b>Type: </b>@message.Type   </td>
                                                                    <td></td>
                                                                    <td><b>Formatting: </b>@message.Formatting    </td>
                                                                    <td></td>
                                                                    <td><b>Source: </b>@message.ChannelSource   </td>
                                                                    <td> </td>
                                                                    <td><b>Status: </b>@message.Status</td>
                                                                    <td></td>
                                                                    <td><b>Created At: </b>@message.CreatedAt</td>
                                                                </tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                    @if (message.Author != null)
                                                    {
                                                        <tr>
                                                            <td>
                                                                <table>
                                                                    <tr>
                                                                        <td><b>Author Type: </b>@message.Author.Role</td>
                                                                        <td></td>
                                                                        <td><b>Name: </b>@message.Author.Profile.FirstName @message.Author.Profile.LastName</td>
                                                                    </tr>
                                                                </table>
                                                            </td>
                                                        </tr>
                                                    }
                                                    <tr>
                                                        <td>
                                                            <table>
                                                                <tr>
                                                                    <td><b>Message: </b>@message.Data</td>
                                                                </tr>
                                                            </table>
                                                        </td>
                                                    </tr>
                                                    @if (message.MessageAttachments != null && message.MessageAttachments.Count > 0)
                                                    {
                                                        <tr><td>Attachment(s) Included</td></tr>
                                                        <tr><td> </td></tr>
                                                        foreach (BreeceWorks.Shared.CaseObjects.MessageAttachment messageAttachment in message.MessageAttachments)
                                                        {
                                                            <tr>
                                                                <td>
                                                                    <table>
                                                                        <tr>
                                                                            <td>
                                                                                Type: @messageAttachment.ContentType
                                                                            </td>
                                                                        </tr>
                                                                        @if (messageAttachment.Extension == ".jpg" || messageAttachment.Extension == ".png" || messageAttachment.Extension == ".bmp")
                                                                        {
                                                                            <tr>
                                                                                <td>
                                                                                    <a href="@String.Format("{0}/api/SMSAttachment/attachment-download/{1}", SMSCoreWebApi ,messageAttachment.Id)" target="_blank"><img id="ItemPreview" height="200" width="200" src="@String.Format("{0}/api/SMSAttachment/attachment-download/{1}", SMSCoreWebApi ,messageAttachment.Id)"></a>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                        else
                                                                        {
                                                                            <tr>
                                                                                <td>
                                                                                    <a href="@String.Format("{0}/api/SMSAttachment/attachment-download/{1}", SMSCoreWebApi ,messageAttachment.Id)" target="_blank">@messageAttachment.Name@messageAttachment.Extension</a>
                                                                                </td>
                                                                            </tr>
                                                                        }
                                                                    </table>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                    <tr><td> </td></tr>
                                                </table>
                                            </li>
                                        }
                                    }
                                </ul>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <td>
                                        <label>Message: </label><InputText @bind-Value="curMessageText" />
                                    </td>
                                    <td>
                                        <button @onclick="@(() => SendMessage())">Send Message</button>
                                    </td>
                                    <td>
                                        <label>Select your file: </label>
                                    </td>
                                    <td>
                                        <InputFile @key="@_inputFileId" OnChange="FileUploaded"></InputFile>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>

            </td>
        </tr>

    </table>
}
